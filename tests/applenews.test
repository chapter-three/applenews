<?php

/**
 * @file
 * Contains tests for the Apple News module.
 */

module_load_include('inc', 'applenews', 'applenews.publisher_api');
module_load_include('inc', 'applenews');
module_load_include('inc', 'applenews', 'applenews.batch');

/**
 * Base class for Apple News web tests.
 */
abstract class ApplenewsWebTestCase extends DrupalWebTestCase {

  protected $watchdogSeverityLevel = WATCHDOG_WARNING;

  protected $adminUser;

  /**
   * {@inheritdoc}
   */
  public function setUp(array $modules = []) {
    parent::setUp(array_merge(['applenews', 'dblog'], $modules));
    $this->adminUser = $this->drupalCreateUser([
      'access content',
      'access administration pages',
      'administer site configuration', 'administer content types', 'administer nodes',
      'create article content', 'edit any article content', 'delete any article content',
      'administer apple news',
    ]);
    $this->drupalLogin($this->adminUser);
  }

  /**
   * {@inheritdoc}
   *
   * @see http://dcycleproject.org/blog/96/catching-watchdog-errors-your-simpletests
   */
  public function tearDown() {
    /** @var SelectQuery $query */
    $query = db_select('watchdog')
      ->fields(NULL, ['wid'])
      ->condition('severity', $this->watchdogSeverityLevel, '<=')
      ->countQuery();
    $count = $query->execute()->fetchField();
    $this->assertTrue($count == 0, 'Found ' . $count . ' watchdog entries.');
    // Uncomment to debug watchdog table.
    // if (!$count)
    parent::tearDown();
  }

}

/**
 * Export nodes using configurable export.
 */
class ApplenewsExportTestCase extends ApplenewsWebTestCase {

  /**
   * {@inheritdoc}
   */
  public static function getInfo() {
    return [
      'name' => t('Export nodes using configurable export.'),
      'description' => '',
      'group' => t('Apple News'),
    ];
  }

  /**
   * {@inheritdoc}
   */
  public function setUp(array $modules = []) {
    parent::setUp(array_merge(['applenews'], $modules));
  }

  /**
   * Primary test.
   */
  public function testExport() {

    // @see ImageFieldDefaultImagesTestCase::ImageFieldDefaultImagesTestCase()
    $file = current($this->drupalGetTestFiles('image'));
    $file = file_save($file);

    // Some node content.
    $contents = [
      [
        '_desc' => 'article',
        'type' => 'article',
        'title' => $this->randomName(32),
        'body' => $this->randomName(64),
        'image' => $file,
        'image_alt' => $this->randomName(32),
      ],
      [
        '_desc' => 'page',
        'type' => 'page',
        'title' => $this->randomName(32),
        'body' => $this->randomName(64),
      ],
    ];

    // Create nodes.
    $map = [];
    foreach ($contents as $i => $content) {
      $settings = [
        'type' => $content['type'],
        'title' => $content['title'],
        'body' => [LANGUAGE_NONE => [['value' => $content['body']]]],
      ];
      if (isset($content['image'])) {
        $settings['field_image'] = [
          LANGUAGE_NONE => [
            [
              'fid' => $content['image']->fid,
              'alt' => $content['image_alt'],
            ],
          ],
        ];
      }
      $node = $this->drupalCreateNode($settings);
      $this->assert($node->nid > 0, "Node \"${content['_desc']}\" created.");
      $map[$node->nid] = $i;
    }

    // Configure export.
    $this->drupalPost(
      'admin/config/content/applenews/exports/add',
      [
        'type' => 'applenews::node',
        'title' => 'admin title',
      ],
      t('Submit')
    );
    $this->drupalPost(
      'admin/config/content/applenews/export/1/edit',
      [
        'config[additional_settings][general_tab][enabled]' => TRUE,
        'config[additional_settings][general_tab][bundles][article]' => TRUE,
        'config[additional_settings][general_tab][bundles][page]' => TRUE,
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = applenews_export_load(1);
    $this->assert($export instanceof ApplenewsExportNode,
      'Export object loaded.');
    $this->assertEqual('admin title', $export->title,
      'Export title.');
    $this->assertEqual(TRUE, $export->enabled,
      'Export enabled.');
    $this->assert(
      in_array('article', $export->bundles()) && in_array('page', $export->bundles()),
      'Export bundles.');

    // Add component destinations.
    $cid_count_weight = 1;
    $this->drupalPost(
      "admin/config/content/applenews/export/1",
      [
        'config[additional_settings][components_tab][components][_new][destination]' => 'applenews::text',
      ],
      t('Save changes')
    );
    $export = applenews_export_load(1);
    $this->assertEqual($cid_count_weight, count($export->getComponents()),
      'New component added.');
    /** @var ApplenewsDestinationBodyPhoto $component */
    $component = $export->getComponent($cid_count_weight);
    $this->assert($component instanceof ApplenewsDestinationText,
      'Destination object loaded.');
    $this->drupalPost(
      "admin/config/content/applenews/export/1/component/${cid_count_weight}",
      [
        'config[title]' => 'Title',
        'config[weight]' => $cid_count_weight,
        'config[settings][component]' => 'title',
        'config[settings][text][source]' => '::::applenews::node::label',
      ],
      t('Save changes')
    );
    $export = applenews_export_load(1);
    /** @var ApplenewsDestinationBodyPhoto $component */
    $component = $export->getComponent($cid_count_weight);
    $this->assert($component instanceof ApplenewsDestinationText,
      'Destination object loaded.');
    $this->assertEqual('Title', $component->title,
      'Destination title.');
    $this->assertEqual($cid_count_weight, $component->weight,
      'Destination weight.');
    $this->assertEqual('title',
      @$component->getSetting('component'),
      'Destination "component" value.');
    $this->assertEqual('::::applenews::node::label',
      @$component->getSetting('text')['source'],
      'Destination "text" source.');

    $cid_count_weight++;
    $this->drupalPost(
      "admin/config/content/applenews/export/1",
      [
        'config[additional_settings][components_tab][components][_new][destination]' => 'applenews::body',
      ],
      t('Save changes')
    );
    $this->drupalPost(
      "admin/config/content/applenews/export/1/component/${cid_count_weight}",
      [
        'config[title]' => 'Body',
        'config[weight]' => $cid_count_weight,
        'config[settings][text][source]' => '::::applenews::field::node::body::value_sanitized',
      ],
      t('Save changes')
    );
    $export = applenews_export_load(1);
    /** @var ApplenewsDestinationBodyPhoto $component */
    $component = $export->getComponent($cid_count_weight);
    $this->assert($component instanceof ApplenewsDestinationBody,
      'Destination object loaded.');
    $this->assertEqual('Body', $component->title,
      'Destination title.');
    $this->assertEqual($cid_count_weight, $component->weight,
      'Destination weight.');
    $this->assertEqual('::::applenews::field::node::body::value_sanitized',
      @$component->getSetting('text')['source'],
      'Destination "text" source.');

    $cid_count_weight++;
    $this->drupalPost(
      "admin/config/content/applenews/export/1",
      [
        'config[additional_settings][components_tab][components][_new][destination]' => 'applenews::scalable_image',
      ],
      t('Save changes')
    );
    $this->drupalPost(
      "admin/config/content/applenews/export/1/component/${cid_count_weight}",
      [
        'config[title]' => 'Image',
        'config[weight]' => $cid_count_weight,
        'config[settings][type]' => 'photo',
        'config[settings][file][source]' => '::::applenews::file::node::field_image::uri',
        'config[settings][caption][source]' => '::::applenews::file::node::field_image::alt',
      ],
      t('Save changes')
    );
    $export = applenews_export_load(1);
    /** @var ApplenewsDestinationBodyPhoto $component */
    $component = $export->getComponent($cid_count_weight);
    $this->assert($component instanceof ApplenewsDestinationScalableImage,
      'Destination object loaded.');
    $this->assertEqual('Image', $component->title,
      'Destination title.');
    $this->assertEqual($cid_count_weight, $component->weight,
      'Destination weight.');
    $this->assertEqual('photo',
      @$component->getSetting('type'),
      'Destination "type" value.');
    $this->assertEqual('::::applenews::file::node::field_image::uri',
      @$component->getSetting('file')['source'],
      'Destination "file" source.');
    $this->assertEqual('::::applenews::file::node::field_image::alt',
      @$component->getSetting('caption')['source'],
      'Destination "caption" source.');

    // Run query to get source ids.
    /** @var EntityFieldQuery $query */
    $query = $export->query();
    $this->assert($query instanceof EntityFieldQuery, 'Query object loaded.');
    $result = $query->execute();
    $a = array_keys($map);
    $b = array_keys($result['node']);
    $this->assert(!array_diff($a, $b) && !array_diff($b, $a), 'Query result.');

    // Export each.
    foreach (array_keys($result['node']) as $nid) {
      $content = $contents[$map[$nid]];

      $document = $export->setSource(node_load($nid))->exportDocument();
      $this->assert($document instanceof \ChapterThree\AppleNewsAPI\Document,
        "Export document for node \"${content['_desc']}\" loaded.");
      $json = $document->json();
      $this->pass(var_export($json, TRUE));
      $data = json_decode($json);
      $this->assert(is_object($data) && !empty($data),
        "Document exported.");

      $this->assertEqual($nid, $data->identifier,
        'Export node nid -> identifier.');
      $this->assertEqual($content['title'], $data->title,
        'Export node title -> title.');

      $cid_count_weight = 1;
      $item = $data->components[$cid_count_weight - 1];
      $this->assertEqual('title', $item->role,
        'Export title component role.');
      $expected = $content['title'];
      $this->assertEqual(trim($expected), trim($item->text),
        "Export title component text -> component ${cid_count_weight} text.");

      $cid_count_weight = 2;
      $item = $data->components[$cid_count_weight - 1];
      $this->assertEqual('body', $item->role,
        'Export body component role.');
      $this->assertEqual('markdown', $item->format,
        'Export body component format.');
      $markdown = new \ChapterThree\AppleNewsAPI\Document\Markdown();
      $expected = $markdown->convert($content['body']);
      $this->assertEqual(trim($expected), trim($item->text),
        "Export body component text -> component ${cid_count_weight} text.");

      if (isset($content['image'])) {
        $cid_count_weight = 3;
        $item = $data->components[$cid_count_weight - 1];
        $this->assertEqual('photo', $item->role,
          'Export scalable_image component role.');
        $this->assertEqual(drupal_realpath($file->uri),
          @$export->getAssets()[$item->URL],
          'Export image -> component 2 image URL.');
        $this->assertEqual($content['image_alt'],
          $item->caption,
          'Export image -> component 2 image caption.');
      }
      else {
        $this->assertEqual($cid_count_weight, count($data->components),
          'Export image missing -> no component');
      }

    }
  }

}

/**
 * Test default article export with inline images.
 */
class ApplenewsExportInlineImagesTestCase extends ApplenewsWebTestCase {

  /**
   * {@inheritdoc}
   */
  public static function getInfo() {
    return [
      'name' => t('Export inline images.'),
      'description' => '',
      'group' => t('Apple News'),
    ];
  }

  /**
   * {@inheritdoc}
   */
  public function setUp(array $modules = []) {
    parent::setUp(array_merge(['applenews'], $modules));
  }

  /**
   * Primary test.
   */
  public function testExport() {

    // @see ImageFieldDefaultImagesTestCase::ImageFieldDefaultImagesTestCase()
    $file = current($this->drupalGetTestFiles('image'));
    $file = file_save($file);
    $file_url = file_create_url($file->uri);
    $file_url_relative = preg_replace('#^https?://localhost#', '', $file_url);

    // Some node content.
    $contents = [
      [
        '_desc' => 'article',
        'type' => 'article',
        'title' => $this->randomName(32),
        'body' => <<<EOD
<p>a well-formed paragraph.</p>
<p>a well-formed paragraph.</p>
<p>a well-formed paragraph.</p>
<img src="${file_url}"/>
<p>a well-formed paragraph.</p>
<p>a paragraph with a nested image: <img src="${file_url_relative}"/></p>
<p>a paragraph with several: <img src="${file_url}"/> and another <img src="${file_url_relative}"/></p>
<p>a well-formed paragraph.</p>
EOD
        ,
        'body_expected' => "a well\\-formed paragraph.\n\na well\\-formed paragraph.\n\na well\\-formed paragraph.\n\n\n\na well\\-formed paragraph.\n\na paragraph with a nested image: \n\na paragraph with several:  and another \n\na well\\-formed paragraph.",

      ],
    ];

    // Create nodes.
    $map = [];
    foreach ($contents as $cid => $content) {
      $settings = [
        'type' => $content['type'],
        'title' => $content['title'],
        'body' => [
          LANGUAGE_NONE => [
            [
              'value' => $content['body'],
              'format' => 'full_html',
            ],
          ],
        ],
      ];
      $node = $this->drupalCreateNode($settings);
      $this->assert($node->nid > 0, "Node \"${content['_desc']}\" created.");
      $map[$node->nid] = $cid;
    }

    // Configure export.
    $this->drupalPost(
      'admin/config/content/applenews/exports/add',
      [
        'type' => 'applenews::node',
        'title' => 'admin title',
      ],
      t('Submit')
    );
    $this->drupalPost(
      'admin/config/content/applenews/export/1/edit',
      [
        'config[additional_settings][general_tab][enabled]' => TRUE,
        'config[additional_settings][general_tab][bundles][article]' => TRUE,
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = applenews_export_load(1);
    $this->assert($export instanceof ApplenewsExportNode,
      'Export object loaded.');
    $this->assertEqual('admin title', $export->title,
      'Export title.');
    $this->assertEqual(TRUE, $export->enabled,
      'Export enabled.');
    $this->assert(in_array('article', $export->bundles()),
      'Export bundles.');
    // Add body+image destination.
    $this->drupalPost(
      "admin/config/content/applenews/export/1",
      [
        'config[additional_settings][components_tab][components][_new][destination]' => 'applenews::bodyphoto',
      ],
      t('Save changes')
    );
    $export = applenews_export_load(1);
    $this->assertEqual(1, count($export->getComponents()),
      'New component added.');
    $cid = 1;
    /** @var ApplenewsDestinationBodyPhoto $component */
    $component = $export->getComponent($cid);
    $this->assert($component instanceof ApplenewsDestinationBodyPhoto,
      'Destination object loaded.');
    $this->drupalPost(
      "admin/config/content/applenews/export/1/component/${cid}",
      [
        'config[title]' => 'body',
        'config[settings][text][source]' => '::::applenews::field::node::body::value_sanitized',
      ],
      t('Save changes')
    );
    $export = applenews_export_load(1);
    /** @var ApplenewsDestinationBodyPhoto $component */
    $component = $export->getComponent($cid);
    $this->assert($component instanceof ApplenewsDestinationBodyPhoto,
      'Destination object loaded.');
    $this->assertEqual('body', $component->title,
      'Destination title.');
    $this->assertEqual('::::applenews::field::node::body::value_sanitized',
      @$component->getSetting('text')['source'],
      'Destination "text" source.');

    // Run query to get source ids.
    /** @var EntityFieldQuery $query */
    $query = $export->query();
    $this->assert($query instanceof EntityFieldQuery, 'Query object loaded.');
    $result = $query->execute();
    $a = array_keys($map);
    $b = array_keys($result['node']);
    $this->assert(!array_diff($a, $b) && !array_diff($b, $a), 'Query result.');

    // Export each.
    foreach (array_keys($result['node']) as $nid) {
      $content = $contents[$map[$nid]];

      $document = $export->setSource(node_load($nid))->exportDocument();
      $this->assert($document instanceof \ChapterThree\AppleNewsAPI\Document,
        "Export document for node \"${content['_desc']}\" loaded.");
      $json = $document->json();
      $this->pass(var_export($json, TRUE));
      $data = json_decode($json);
      $this->assert(is_object($data) && !empty($data),
        "Document exported.");

      $this->assertEqual($nid, $data->identifier,
        'Export node nid -> identifier.');
      $this->assertEqual($content['title'], $data->title,
        'Export node title -> title.');

      $cid = 1;
      $item = $data->components[$cid - 1];
      $this->assertEqual('body', $item->role,
        "Export component ${cid} role.");
      $this->assertEqual('markdown', $item->format,
        "Export component ${cid} format.");
      $this->assertEqual($content['body_expected'], $item->text,
        "Export body fragment -> component ${cid} body text.");

      $cid++;
      $item = $data->components[$cid - 1];
      $this->assertEqual('photo', $item->role,
        "Export component ${cid} role.");
      $this->assertEqual(drupal_realpath($file->uri),
        @$export->getAssets()[$item->URL],
        "Export body fragment -> component ${cid} image URL.");

      $cid++;
      $item = $data->components[$cid - 1];
      $this->assertEqual('photo', $item->role,
        "Export component ${cid} role.");
      $this->assertEqual(drupal_realpath($file->uri),
        @$export->getAssets()[$item->URL],
        "Export body fragment -> component ${cid} image URL.");

      $cid++;
      $item = $data->components[$cid - 1];
      $this->assertEqual('photo', $item->role,
        "Export component ${cid} role.");
      $this->assertEqual(drupal_realpath($file->uri),
        @$export->getAssets()[$item->URL],
        "Export body fragment -> component ${cid} image URL.");

      $cid++;
      $item = $data->components[$cid - 1];
      $this->assertEqual('photo', $item->role,
        "Export component ${cid} role.");
      $this->assertEqual(drupal_realpath($file->uri),
        @$export->getAssets()[$item->URL],
        "Export body fragment -> component ${cid} image URL.");

    }
  }

}

/**
 * Test metadata configuration.
 */
class ApplenewsExportMetadataTestCase extends ApplenewsWebTestCase {

  /**
   * {@inheritdoc}
   */
  public static function getInfo() {
    return [
      'name' => t('Export metadata.'),
      'description' => '',
      'group' => t('Apple News'),
    ];
  }

  /**
   * {@inheritdoc}
   */
  public function setUp(array $modules = []) {
    parent::setUp(array_merge(['applenews'], $modules));
  }

  /**
   * Primary test.
   */
  public function testExport() {

    // @see ImageFieldDefaultImagesTestCase::ImageFieldDefaultImagesTestCase()
    $file = current($this->drupalGetTestFiles('image'));
    $file = file_save($file);

    // Some node content.
    $contents = [
      [
        '_desc' => 'article',
        'type' => 'article',
        'title' => $this->randomName(32),
        'body' => $this->randomName(64),
        'image' => $file,
        'image_alt' => $this->randomName(32),
      ],
    ];

    // Create nodes.
    $map = [];
    foreach ($contents as $i => $content) {
      $settings = [
        'type' => $content['type'],
        'title' => $content['title'],
        'body' => [LANGUAGE_NONE => [['value' => $content['body']]]],
      ];
      if (isset($content['image'])) {
        $settings['field_image'] = [
          LANGUAGE_NONE => [
            [
              'fid' => $content['image']->fid,
              'alt' => $content['image_alt'],
            ],
          ],
        ];
      }
      $node = $this->drupalCreateNode($settings);
      $this->assert($node->nid > 0, "Node \"${content['_desc']}\" created.");
      $map[$node->nid] = $i;
    }

    // Configure export.
    $this->drupalPost(
      'admin/config/content/applenews/exports/add',
      [
        'type' => 'applenews::node',
        'title' => 'admin title',
      ],
      t('Submit')
    );
    $this->drupalPost(
      'admin/config/content/applenews/export/1/edit',
      [
        'config[additional_settings][general_tab][enabled]' => TRUE,
        'config[additional_settings][general_tab][bundles][article]' => TRUE,
      ],
      t('Save changes')
    );
    $this->drupalPost(
      "admin/config/content/applenews/export/1",
      [
        'config[additional_settings][components_tab][components][_new][destination]' => 'applenews::text',
      ],
      t('Save changes')
    );
    $this->drupalPost(
      "admin/config/content/applenews/export/1/component/1",
      [
        'config[title]' => 'title',
        'config[weight]' => 1,
        'config[settings][component]' => 'title',
        'config[settings][text][source]' => '::::applenews::node::label',
      ],
      t('Save changes')
    );

    // Set document metadata.
    $this->drupalPost(
      'admin/config/content/applenews/export/1/edit',
      [
        'config[additional_settings][metadata_tab][is_preview]' => TRUE,
        'config[additional_settings][metadata_tab][metadata_destination][settings][date_published][source]' => '::::applenews::node::changed',
        'config[additional_settings][metadata_tab][metadata_destination][settings][date_created][source]' => '',
        'config[additional_settings][metadata_tab][metadata_destination][settings][authors][source]' => '::::applenews::value::value',
        'config[additional_settings][metadata_tab][metadata_destination][settings][authors][value]' => 'Chapter Three',
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = applenews_export_load(1);
    $metadata = $export->getMetadata();
    $this->assertEqual(TRUE, $export->getSetting('is_preview'),
      'Metadata is preview');
    $this->assertEqual('::::applenews::node::changed',
      @$metadata->getSetting('date_published')['source'],
      'Metadata date_published source');
    $this->assertEqual('',
      @$metadata->getSetting('date_created')['source'],
      'Metadata date_created source');
    $this->assertEqual('::::applenews::value::value',
      @$metadata->getSetting('authors')['source'],
      'Metadata authors source');
    $this->assertEqual('Chapter Three',
      @$metadata->getSetting('authors')['value'],
      'Metadata authors value');

    // Run query to get source ids.
    /** @var EntityFieldQuery $query */
    $query = $export->query();
    $this->assert($query instanceof EntityFieldQuery, 'Query object loaded.');
    $result = $query->execute();
    $a = array_keys($map);
    $b = array_keys($result['node']);
    $this->assert(!array_diff($a, $b) && !array_diff($b, $a), 'Query result.');

    // Export each.
    foreach (array_keys($result['node']) as $nid) {
      $content = $contents[$map[$nid]];

      $node = node_load($nid);
      /** @var EntityDrupalWrapper $wrapper */
      $wrapper = entity_metadata_wrapper('node', $node);

      $document = $export->setSource($node)->exportDocument();
      $this->assert($document instanceof \ChapterThree\AppleNewsAPI\Document,
        "Export document for node \"${content['_desc']}\" loaded.");
      $json = $document->json();
      $this->pass(var_export($json, TRUE));
      $data = json_decode($json);
      $this->assert(is_object($data) && !empty($data),
        "Document exported.");

      /** @var EntityValueWrapper $changed */
      $changed = $wrapper->get('changed');
      /** @var string $changed_timestamp */
      $changed_timestamp = $changed->value();
      /** @var DateTime $changed */
      $changed_obj = date_timestamp_set(new DateTime(), $changed_timestamp);
      $date_published = new DateTime($data->metadata->datePublished);
      $diff = $changed_obj->diff($date_published);
      $this->assertEqual(0, $diff->s,
        'Metadata datePublished.');

      $this->assert(empty($data->dateCreated),
        'Metadata dateCreated');

      $this->assertEqual('Chapter Three', @$data->metadata->authors[0],
        'Metadata authors');

    }
  }

}

/**
 * Test layout configuration.
 */
class ApplenewsExportLayoutTestCase extends ApplenewsWebTestCase {

  /**
   * {@inheritdoc}
   */
  public static function getInfo() {
    return [
      'name' => t('Export layout.'),
      'description' => '',
      'group' => t('Apple News'),
    ];
  }

  /**
   * {@inheritdoc}
   */
  public function setUp(array $modules = []) {
    parent::setUp(array_merge(['applenews'], $modules));
  }

  /**
   * Primary test.
   */
  public function testExport() {

    // @see ImageFieldDefaultImagesTestCase::ImageFieldDefaultImagesTestCase()
    $file = current($this->drupalGetTestFiles('image'));
    $file = file_save($file);
    $file_url = file_create_url($file->uri);

    // Some node content.
    $contents = [
      [
        '_desc' => 'article',
        'type' => 'article',
        'title' => $this->randomName(32),
        'body' => "paragraph 1.\n\n<img src=\"${file_url}\"/>\n\nparagraph2.",
        'image' => $file,
        'image_alt' => $this->randomName(32),
      ],
    ];

    // Create nodes.
    $map = [];
    foreach ($contents as $i => $content) {
      $settings = [
        'type' => $content['type'],
        'title' => $content['title'],
        'body' => [
          LANGUAGE_NONE => [
            [
              'value' => $content['body'],
              'format' => 'full_html',
            ],
          ],
        ],
      ];
      if (isset($content['image'])) {
        $settings['field_image'] = [
          LANGUAGE_NONE => [
            [
              'fid' => $content['image']->fid,
              'alt' => $content['image_alt'],
            ],
          ],
        ];
      }
      $node = $this->drupalCreateNode($settings);
      $this->assert($node->nid > 0, "Node \"${content['_desc']}\" created.");
      $map[$node->nid] = $i;
    }

    // Configure export.
    $this->drupalPost(
      'admin/config/content/applenews/exports/add',
      [
        'type' => 'applenews::node',
        'title' => 'admin title',
      ],
      t('Submit')
    );
    $this->drupalPost(
      'admin/config/content/applenews/export/1/edit',
      [
        'config[additional_settings][general_tab][enabled]' => TRUE,
        'config[additional_settings][general_tab][bundles][article]' => TRUE,
      ],
      t('Save changes')
    );

    // Add component destinations.
    $this->drupalPost(
      "admin/config/content/applenews/export/1",
      [
        'config[additional_settings][components_tab][components][_new][destination]' => 'applenews::text',
      ],
      t('Save changes')
    );
    $this->drupalPost(
      "admin/config/content/applenews/export/1/component/1",
      [
        'config[title]' => 'title',
        'config[weight]' => 1,
        'config[settings][component]' => 'title',
        'config[settings][text][source]' => '::::applenews::node::label',
      ],
      t('Save changes')
    );
    $this->drupalPost(
      "admin/config/content/applenews/export/1",
      [
        'config[additional_settings][components_tab][components][_new][destination]' => 'applenews::bodyphoto',
      ],
      t('Save changes')
    );
    $this->drupalPost(
      "admin/config/content/applenews/export/1/component/2",
      [
        'config[title]' => 'body',
        'config[weight]' => 2,
        'config[settings][text][source]' => '::::applenews::field::node::body::value_sanitized',
      ],
      t('Save changes')
    );

    // Set document layout.
    $this->drupalPost(
      'admin/config/content/applenews/export/1/edit',
      [
        'config[additional_settings][layouts_tab][layout_destination][settings][columns]' => '12',
        'config[additional_settings][layouts_tab][layout_destination][settings][width]' => '960',
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = applenews_export_load(1);
    $layout = $export->getLayout();
    $this->assertEqual('12', $layout->getSetting('columns'),
      'Layout columns');
    $this->assertEqual('960', $layout->getSetting('width'),
      'Layout width');

    // Set title layout.
    $this->drupalPost(
      'admin/config/content/applenews/export/1/component/1',
      [
        'config[layouts][0][id]' => '',
        'config[layouts][0][custom][settings][columnStart]' => '0',
        'config[layouts][0][custom][settings][columnSpan]' => '12',
        'config[layouts][0][custom][settings][margin][type]' => 'value',
        'config[layouts][0][custom][settings][margin][value]' => '5',
        'config[layouts][0][custom][settings][contentInset][type]' => 'contentInset',
        'config[layouts][0][custom][settings][contentInset][top]' => TRUE,
        'config[layouts][0][custom][settings][contentInset][right]' => TRUE,
        'config[layouts][0][custom][settings][contentInset][bottom]' => FALSE,
        'config[layouts][0][custom][settings][contentInset][left]' => TRUE,
        'config[layouts][0][custom][settings][ignoreDocumentMargin]' => 'both',
        'config[layouts][0][custom][settings][ignoreDocumentGutter]' => '',
        'config[layouts][0][custom][settings][horizontalContentAlignment]' => FALSE,
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = applenews_export_load(1);
    $layout = $export->getComponent(1)->getLayout();
    $this->assertEqual('0', $layout->getSetting('columnStart'),
      'Layout columnStart');
    $this->assertEqual('12', $layout->getSetting('columnSpan'),
      'Layout columnSpan');
    $this->assertEqual('value', @$layout->getSetting('margin')['type'],
      'Layout margin type');
    $this->assertEqual('5', @$layout->getSetting('margin')['value'],
      'Layout margin value');
    $this->assertEqual('contentInset', @$layout->getSetting('contentInset')['type'],
      'Layout contentInset type');
    $this->assertEqual(TRUE, @$layout->getSetting('contentInset')['top'],
      'Layout contentInset top');
    $this->assertEqual(TRUE, @$layout->getSetting('contentInset')['right'],
      'Layout contentInset right');
    $this->assertEqual(FALSE, @$layout->getSetting('contentInset')['bottom'],
      'Layout contentInset bottom');
    $this->assertEqual(TRUE, @$layout->getSetting('contentInset')['left'],
      'Layout contentInset left');
    $this->assertEqual('both', $layout->getSetting('ignoreDocumentMargin'),
      'Layout ignoreDocumentMargin');
    $this->assertEqual('', $layout->getSetting('ignoreDocumentGutter'),
      'Layout ignoreDocumentGutter');
    $this->assertEqual(FALSE, $layout->getSetting('horizontalContentAlignment'),
      'Layout horizontalContentAlignment');

    // Create componentLayout for body.
    $this->drupalPost(
      'admin/config/content/applenews/export/1/edit',
      [
        'config[additional_settings][layouts_tab][component_layouts][_new][destination]' => TRUE,
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = applenews_export_load(1);
    $layout = $export->getComponentLayout(1);
    $this->assert($layout instanceof ApplenewsDestinationComponentLayout,
      'componentLayout created.');
    $this->drupalPost(
      'admin/config/content/applenews/export/1/componentLayout/1',
      [
        'config[title]' => 'Body',
        'config[id]' => 'body',
        'config[settings][columnStart]' => '1',
        'config[settings][columnSpan]' => '10',
        'config[settings][margin][type]' => 'margin',
        'config[settings][margin][top]' => '5',
        'config[settings][margin][bottom]' => '10',
        'config[settings][contentInset][type]' => 'default',
        'config[settings][contentInset][default]' => TRUE,
        'config[settings][ignoreDocumentMargin]' => '',
        'config[settings][ignoreDocumentGutter]' => 'left',
        'config[settings][minimumHeight][value]' => '10',
        'config[settings][minimumHeight][units]' => 'pt',
        'config[settings][maximumContentWidth][value]' => '500',
        'config[settings][maximumContentWidth][units]' => 'vmax',
        'config[settings][horizontalContentAlignment]' => 'center',
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = applenews_export_load(1);
    $layout = $export->getComponentLayout('body');
    $this->assertEqual('Body', $layout->title,
      'Layout title');
    $this->assertEqual('1', $layout->getSetting('columnStart'),
      'Layout columnStart');
    $this->assertEqual('10', $layout->getSetting('columnSpan'),
      'Layout columnSpan');
    $this->assertEqual('margin', @$layout->getSetting('margin')['type'],
      'Layout margin type');
    $this->assertEqual('5', @$layout->getSetting('margin')['top'],
      'Layout margin top');
    $this->assertEqual('10', @$layout->getSetting('margin')['bottom'],
      'Layout margin bottom');
    $this->assertEqual('default', @$layout->getSetting('contentInset')['type'],
      'Layout contentInset type');
    $this->assertEqual(TRUE, @$layout->getSetting('contentInset')['default'],
      'Layout contentInset default');
    $this->assertEqual('', $layout->getSetting('ignoreDocumentMargin'),
      'Layout ignoreDocumentMargin');
    $this->assertEqual('left', $layout->getSetting('ignoreDocumentGutter'),
      'Layout ignoreDocumentGutter');
    $this->assertEqual('10', @$layout->getSetting('minimumHeight')['value'],
      'Layout minimumHeight value');
    $this->assertEqual('pt', @$layout->getSetting('minimumHeight')['units'],
      'Layout minimumHeight units');
    $this->assertEqual('500', @$layout->getSetting('maximumContentWidth')['value'],
      'Layout maximumContentWidth value');
    $this->assertEqual('vmax', @$layout->getSetting('maximumContentWidth')['units'],
      'Layout maximumContentWidth units');
    $this->assertEqual(TRUE, $layout->getSetting('horizontalContentAlignment'),
      'Layout horizontalContentAlignment');

    // Create componentLayout for inline images.
    $this->drupalPost(
      'admin/config/content/applenews/export/1/edit',
      [
        'config[additional_settings][layouts_tab][component_layouts][_new][destination]' => TRUE,
      ],
      t('Save changes')
    );
    $this->drupalPost(
      'admin/config/content/applenews/export/1/componentLayout/2',
      [
        'config[title]' => 'Inline Images',
        'config[id]' => 'inline_images',
        'config[settings][columnStart]' => '0',
        'config[settings][columnSpan]' => '12',
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = applenews_export_load(1);
    $layout = $export->getComponentLayout('inline_images');
    $this->assertEqual('Inline Images', $layout->title,
      'Layout title');
    $this->assertEqual('0', $layout->getSetting('columnStart'),
      'Layout columnStart');
    $this->assertEqual('12', $layout->getSetting('columnSpan'),
      'Layout columnSpan');

    // Set body and inline images layout.
    $this->drupalPost(
      'admin/config/content/applenews/export/1/component/2',
      [
        'config[layouts][0][id]' => 'body',
        'config[layouts][1][id]' => 'inline_images',
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = applenews_export_load(1);
    $layout = $export->getComponent(2)->getLayout();
    $this->assert($layout instanceof ApplenewsDestinationComponentLayout,
      'Component layout reference loaded');
    $layout = $export->getComponent(2)->getLayout('image');
    $this->assert($layout instanceof ApplenewsDestinationComponentLayout,
      'Component layout reference loaded');

    // Run query to get source ids.
    /** @var EntityFieldQuery $query */
    $query = $export->query();
    $this->assert($query instanceof EntityFieldQuery, 'Query object loaded.');
    $result = $query->execute();
    $a = array_keys($map);
    $b = array_keys($result['node']);
    $this->assert(!array_diff($a, $b) && !array_diff($b, $a), 'Query result.');

    // Export each.
    foreach (array_keys($result['node']) as $nid) {
      $content = $contents[$map[$nid]];

      $document = $export->setSource(node_load($nid))->exportDocument();
      $this->assert($document instanceof \ChapterThree\AppleNewsAPI\Document,
        "Export document for node \"${content['_desc']}\" loaded.");
      $json = $document->json();
      $this->pass(var_export($json, TRUE));
      $data = json_decode($json);
      $this->assert(is_object($data) && !empty($data),
        "Document exported.");

      $layout = @$data->components[0]->layout;
      $this->assert(is_object(@$layout),
        'Title layout exported');
      $this->assertEqual('0', @$layout->columnStart,
        'Layout columnStart');
      $this->assertEqual('12', @$layout->columnSpan,
        'Layout columnSpan');
      $this->assertEqual('5', @$layout->margin,
        'Layout margin value');
      $this->assertEqual(TRUE, @$layout->contentInset->top,
        'Layout contentInset top');
      $this->assertEqual(TRUE, @$layout->contentInset->right,
        'Layout contentInset right');
      $this->assertEqual(FALSE, @$layout->contentInset->bottom,
        'Layout contentInset bottom');
      $this->assertEqual(TRUE, @$layout->contentInset->left,
        'Layout contentInset left');
      $this->assertEqual('both', @$layout->ignoreDocumentMargin,
        'Layout ignoreDocumentMargin');
      $this->assertEqual('', @$layout->ignoreDocumentGutter,
        'Layout ignoreDocumentGutter');
      $this->assertEqual(FALSE, @$layout->horizontalContentAlignment,
        'Layout horizontalContentAlignment');

      $layout = @$data->components[1]->layout;
      $this->assertEqual('body', $layout,
        'Body layout set');
      $layout = @$data->componentLayouts->$layout;
      $this->assert(is_object($layout),
        'Body layout exported');
      $this->assertEqual('1', @$layout->columnStart,
        'Layout columnStart');
      $this->assertEqual('10', @$layout->columnSpan,
        'Layout columnSpan');
      $this->assertEqual('5', @$layout->margin->top,
        'Layout margin top');
      $this->assertEqual('10', @$layout->margin->bottom,
        'Layout margin bottom');
      $this->assertEqual(TRUE, @$layout->contentInset,
        'Layout contentInset default');
      $this->assertEqual(NULL, @$layout->ignoreDocumentMargin,
        'Layout ignoreDocumentMargin');
      $this->assertEqual('left', @$layout->ignoreDocumentGutter,
        'Layout ignoreDocumentGutter');
      $this->assertEqual('10pt', @$layout->minimumHeight,
        'Layout minimumHeight value');
      $this->assertEqual('500vmax', @$layout->maximumContentWidth,
        'Layout maximumContentWidth value');
      $this->assertEqual(TRUE, @$layout->horizontalContentAlignment,
        'Layout horizontalContentAlignment');

      $layout = @$data->components[2]->layout;
      $this->assertEqual('inline_images', $layout,
        'Body layout set');
      $layout = @$data->componentLayouts->$layout;
      $this->assert(is_object($layout),
        'Inline Images layout exported');
      $this->assertEqual('0', @$layout->columnStart,
        'Layout columnStart');
      $this->assertEqual('12', @$layout->columnSpan,
        'Layout columnSpan');

    }
  }

}
