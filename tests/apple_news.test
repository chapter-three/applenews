<?php

/**
 * @file
 * Contains tests for the Apple News module.
 */

module_load_include('inc', 'apple_news', 'apple_news.publisher_api');
module_load_include('inc', 'apple_news');
module_load_include('inc', 'apple_news', 'apple_news.batch');

/**
 * Base class for Apple News web tests.
 */
abstract class ApplenewsWebTestCase extends DrupalWebTestCase {

  protected $watchdogSeverityLevel = WATCHDOG_WARNING;

  protected $admin_user;

  /**
   * {@inheritdoc}
   */
  public function setUp(array $modules = []) {
    parent::setUp(array_merge(['apple_news', 'dblog'], $modules));
    $this->admin_user = $this->drupalCreateUser([
      'access content',
      'access administration pages',
      'administer site configuration', 'administer content types', 'administer nodes',
      'create article content', 'edit any article content', 'delete any article content',
      'administer apple news',
    ]);
    $this->drupalLogin($this->admin_user);
  }

  /**
   * {@inheritdoc}
   *
   * @see http://dcycleproject.org/blog/96/catching-watchdog-errors-your-simpletests
   */
  public function tearDown() {
    $query = db_select('watchdog')
      ->fields(NULL, ['wid'])
      ->condition('severity', $this->watchdogSeverityLevel, '<=')
      ->countQuery();
    $count = $query->execute()->fetchField();
    $this->assertTrue($count == 0, 'Found ' . $count . ' watchdog entries.');
    // Uncomment to debug watchdog table.
    // if (!$count)
    parent::tearDown();
  }

}

/**
 * Test export to Apple News Format.
 */
class ApplenewsExportTestCase extends ApplenewsWebTestCase {

  /**
   * {@inheritdoc}
   */
  public static function getInfo() {
    return [
      'name' => t('Export article using configurable export.'),
      'description' => t('Export to Apple News Format, articles as defined by default profile, using configurable export.'),
      'group' => t('Apple News'),
    ];
  }

  /**
   * {@inheritdoc}
   */
  public function setUp(array $modules = []) {
    parent::setUp(array_merge(['apple_news_article'], $modules));
  }

  /**
   * Test default article export using simple layout.
   */
  public function testExport() {

    // @see ImageFieldDefaultImagesTestCase::ImageFieldDefaultImagesTestCase()
    $file = current($this->drupalGetTestFiles('image'));
    $file = file_save($file);

    // Some node content.
    $contents = [
      [
        '_desc' => 'article',
        'type' => 'article',
        'title' => $this->randomName(32),
        'body' => $this->randomName(64),
        'image' => $file,
        'image_title' => $this->randomName(32),
      ],
      [
        '_desc' => 'page',
        'type' => 'page',
        'title' => $this->randomName(32),
        'body' => $this->randomName(64),
      ],
    ];

    // Create nodes.
    $map = [];
    foreach ($contents as $i => $content) {
      $settings = [
        'type' => $content['type'],
        'title' => $content['title'],
        'body' => [LANGUAGE_NONE => [['value' => $content['body']]]],
      ];
      if (isset($content['image'])) {
        $settings['field_image'] = [LANGUAGE_NONE => [[
          'fid' => $content['image']->fid,
          'title' => $content['image_title'],
        ]]];
      }
      $node = $this->drupalCreateNode($settings);
      $this->assert($node->nid > 0, "Node \"${content['_desc']}\" created.");
      $map[$node->nid] = $i;
    }

    // Enable, configure export.
    $this->drupalPost(
      'admin/config/content/apple-news/exports/apple_news::node/edit',
      [
        'enabled' => TRUE,
        'bundles[]' => ['article', 'page'],
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = apple_news_get_export('apple_news', 'node');
    $this->assert($export instanceof ApplenewsExportNode,
      "Export object loaded.");
    // Add component.
    $this->drupalPost(
      'admin/config/content/apple-news/exports/apple_news::node/edit',
      [
        'components[_new][destination]' => 'apple_news::body',
        'components[_new][weight]' => '1',
      ],
      t('Save changes')
    );
    // Configure component.
    $this->drupalPost(
      'admin/config/content/apple-news/exports/apple_news::node/component/1',
      [
        'text[source]' => '::::apple_news::field::node::body::value',
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = apple_news_get_export('apple_news', 'node', TRUE);
    /** @var ApplenewsDestinationBodyPhoto $component */
    $component = $export->getComponent(1);
    $this->assert($component instanceof ApplenewsDestinationBody,
      "Destination object loaded.");
    // Add component.
    $this->drupalPost(
      'admin/config/content/apple-news/exports/apple_news::node/edit',
      [
        'components[_new][destination]' => 'apple_news::scalable_image',
        'components[_new][weight]' => '2',
      ],
      t('Save changes')
    );
    // Configure component.
    $this->drupalPost(
      'admin/config/content/apple-news/exports/apple_news::node/component/2',
      [
        'file[source]' => '::::apple_news::file::node::field_image::uri',
        'caption[source]' => '::::apple_news::file::node::field_image::title',
        'type' => 'photo',
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = apple_news_get_export('apple_news', 'node', TRUE);
    /** @var ApplenewsDestinationBodyPhoto $component */
    $component = $export->getComponent(2);
    $this->assert($component instanceof ApplenewsDestinationScalableImage,
      "Destination object loaded.");

    // Run query to get source ids.
    /** @var EntityFieldQuery $query */
    $query = $export->query();
    $this->assert($query instanceof EntityFieldQuery, 'Query object loaded.');
    $result = $query->execute();
    $a = array_keys($map);
    $b = array_keys($result['node']);
    $this->assert(!array_diff($a, $b) && !array_diff($b, $a), 'Query result.');

    // Export each.
    foreach (array_keys($result['node']) as $nid) {
      $content = $contents[$map[$nid]];

      $document = $export->setSource(node_load($nid))->export();
      $this->assert($document instanceof \ChapterThree\AppleNews\Document,
        "Export document for node \"${content['_desc']}\" loaded.");
      $json = $document->json();
      $this->pass(var_export($json, TRUE));
      $data = json_decode($json);
      $this->assert(is_object($data) && !empty($data),
        "Document exported.");

      $this->assertEqual($nid, $data->identifier,
        'Export node nid -> identifier.');
      $this->assertEqual($content['title'], $data->title,
        'Export node title -> title.');

      $item = $data->components[0];
      $this->assertEqual('body', $item->role,
        'Export body component role.');
      $this->assertEqual('markdown', $item->format,
        'Export body component format.');
      $markdown = new \ChapterThree\AppleNews\Document\Markdown();
      $expected = $markdown->convert($content['body']);
      $this->assertEqual(trim($expected), trim($item->text),
        'Export body component text -> component 1 text.');

      if (isset($content['image'])) {
        $item = $data->components[1];
        $this->assertEqual('photo', $item->role,
          'Export scalable_image component role.');
        $this->assertEqual(drupal_realpath($file->uri),
          @$export->getAssets()[$item->URL],
          'Export image -> component 2 image URL.');
        $this->assertEqual($content['image_title'],
          $item->caption,
          'Export image -> component 2 image caption.');
      }
      else {
        $this->assertEqual(1, count($data->components),
          'Export image missing -> no component');
      }

    }
  }

  /**
   * Test default article export with inline images.
   */
  public function testExportInlineImages() {

    // @see ImageFieldDefaultImagesTestCase::ImageFieldDefaultImagesTestCase()
    $file = current($this->drupalGetTestFiles('image'));
    $file = file_save($file);
    $file_url = file_create_url($file->uri);
    $file_url_relative = preg_replace('#^https?://localhost#', '', $file_url);

    // Some node content.
    $contents = [
      [
        '_desc' => 'article',
        'type' => 'article',
        'title' => $this->randomName(32),
        'body' => <<<EOD
<p>a well-formed paragraph.</p>
<p>a well-formed paragraph.</p>
<p>a well-formed paragraph.</p>
<img src="${file_url}"/>
<p>a well-formed paragraph.</p>
<p>a paragraph with a nested image: <img src="${file_url_relative}"/></p>
<p>a well-formed paragraph.</p>
EOD
        ,
      ],
    ];

    // Create nodes.
    $map = [];
    foreach ($contents as $i => $content) {
      $settings = [
        'type' => $content['type'],
        'title' => $content['title'],
        'body' => [
          LANGUAGE_NONE => [
            [
              'value' => $content['body'],
              'format' => 'full_html',
            ],
          ],
        ],
      ];
      $node = $this->drupalCreateNode($settings);
      $this->assert($node->nid > 0, "Node \"${content['_desc']}\" created.");
      $map[$node->nid] = $i;
    }

    // Enable, configure export.
    $this->drupalPost(
      'admin/config/content/apple-news/exports/apple_news::node/edit',
      [
        'enabled' => TRUE,
        'bundles[]' => ['article'],
      ],
      t('Save changes')
    );
    // Add component.
    $this->drupalPost(
      'admin/config/content/apple-news/exports/apple_news::node/edit',
      [
        'components[_new][destination]' => 'apple_news::bodyphoto',
        'components[_new][weight]' => '0',
      ],
      t('Save changes')
    );
    // Configure component.
    $this->drupalPost(
      'admin/config/content/apple-news/exports/apple_news::node/component/1',
      [
        'text[source]' => '::::apple_news::field::node::body::value',
      ],
      t('Save changes')
    );
    /** @var ApplenewsExportNode $export */
    $export = apple_news_get_export('apple_news', 'node');
    $this->assert($export instanceof ApplenewsExportNode,
      "Export object loaded.");
    /** @var ApplenewsDestinationBodyPhoto $component */
    $component = $export->getComponent(1);
    $this->assert($component instanceof ApplenewsDestinationBodyPhoto,
      "Destination object loaded.");

    // Run query to get source ids.
    /** @var EntityFieldQuery $query */
    $query = $export->query();
    $this->assert($query instanceof EntityFieldQuery, 'Query object loaded.');
    $result = $query->execute();
    $a = array_keys($map);
    $b = array_keys($result['node']);
    $this->assert(!array_diff($a, $b) && !array_diff($b, $a), 'Query result.');

    $markdown = new \ChapterThree\AppleNews\Document\Markdown();

    // Export each.
    foreach (array_keys($result['node']) as $nid) {
      $content = $contents[$map[$nid]];

      $document = $export->setSource(node_load($nid))->export();
      $this->assert($document instanceof \ChapterThree\AppleNews\Document,
        "Export document for node \"${content['_desc']}\" loaded.");
      $json = $document->json();
      $this->pass(var_export($json, TRUE));
      $data = json_decode($json);
      $this->assert(is_object($data) && !empty($data),
        "Document exported.");

      $this->assertEqual($nid, $data->identifier,
        'Export node nid -> identifier.');
      $this->assertEqual($content['title'], $data->title,
        'Export node title -> title.');

      $item = $data->components[0];
      $this->assertEqual('body', $item->role,
        'Export body component role.');
      $this->assertEqual('markdown', $item->format,
        'Export body component format.');
      $expected = <<<'EOD'
<p>a well-formed paragraph.</p>
<p>a well-formed paragraph.</p>
<p>a well-formed paragraph.</p>
EOD;
      $expected = $markdown->convert($expected);
      $this->assertEqual($expected, $item->text,
        'Export body fragment -> component 1 body text.');

      $item = $data->components[1];
      $this->assertEqual('photo', $item->role,
        'Export inline image component role.');
      $this->assertEqual(drupal_realpath($file->uri),
        @$export->getAssets()[$item->URL],
        'Export body fragment -> component 2 image URL.');

      $item = $data->components[2];
      $this->assertEqual('body', $item->role,
        'Export body component role.');
      $this->assertEqual('markdown', $item->format,
        'Export body component format.');
      $expected = <<<'EOD'
<p>a well-formed paragraph.</p>
<p>a paragraph with a nested image: </p>
EOD;
      $expected = $markdown->convert($expected);
      $this->assertEqual($expected, $item->text,
        'Export body fragment -> component 3 body text.');

      $item = $data->components[3];
      $this->assertEqual('photo', $item->role,
        'Export inline image component role.');
      $this->assertEqual(drupal_realpath($file->uri),
        @$export->getAssets()[$item->URL],
        'Export body fragment -> component 4 image URL.');

      $item = $data->components[4];
      $this->assertEqual('body', $item->role,
        'Export body component role.');
      $this->assertEqual('markdown', $item->format,
        'Export body component format.');
      $expected = <<<'EOD'
<p>a well-formed paragraph.</p>
EOD;
      $expected = $markdown->convert($expected);
      $this->assertEqual($expected, $item->text,
        'Export body fragment -> component 5 body text.');

    }
  }

}
